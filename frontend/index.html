<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthonnel Parley</title>
    <style>
        :root {
            --backgroundColor: #F0F0F0;
            --textColor: #0F0F0F;
            --emphasisBackgroundColor: #FFFFFF;
            --borderColor: #C0C0C0;
            --headerRow-height: 1px;
        }
        body {
            font-family: Verdana, Arial, Tahoma, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--backgroundColor);
            color: var(--textColor);
            line-height: 28px;
            font-size: 16px;
            -webkit-transition: all .35s ease-in-out;
            transition: all .35s ease-in-out;
        }

        .button {
            cursor: pointer;
            font-size: 24px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: 44px;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }
        .button-wide {
            cursor: pointer;
            font-size: 24px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: 104px;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }
        .small-text-wide-button {
            cursor: pointer;
            font-size: 18px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: 100%;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }
        .small-text-just-wide-enough-button {
            cursor: pointer;
            font-size: 18px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: fit-content;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }

        #addItemBtn {
            position: fixed; 
            left: 104px; 
            bottom: 10px; 
            background-color: var(--emphasisBackgroundColor);
        }
        #addItemFormHider {
            display:none
        }
        #addItemForm {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: fixed; 
            left: 20px;
            bottom: 80px; 
            background: var(--emphasisBackgroundColor); 
            padding: 20px; 
            border: 1px solid var(--borderColor); 
            display: inline-flex;
            gap: 20px;
            padding-top: 44px;
            z-index: 1;
        }

        #userPrompt {
            left: 174px;
            right: 174px;
            overflow-y: hidden;
            margin: 0 auto;
            min-height: 1px;
            resize: none;
            position: fixed;
            bottom: 10px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            font-size: 120%;
            padding-top: 12px;
            padding-bottom: 0px;
            padding-right: 18px;
            padding-left: 18px;
            background-color: var(--emphasisBackgroundColor);
            color: var(--textColor);
        }

        #submitPrompt {
            position: fixed; 
            right: 104px; 
            bottom: 10px; 
            opacity: 0.3;
            background-color: var(--emphasisBackgroundColor);
        }

        #settingsBtn {
            position: fixed; 
            right: 30px; 
            bottom: 10px; 
            background-color: var(--emphasisBackgroundColor);
        }
        #settingsFormHider {
            display:none
        }
        #settingsForm {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: fixed; 
            right: 20px;
            bottom: 80px; 
            background: var(--emphasisBackgroundColor); 
            padding: 20px; 
            border: 1px solid var(--borderColor); 
            gap: 20px;
            z-index: 1;
        }

        #message {
            position: absolute;
            top: -50px;
            left: 0px;
            background-color: white;
            color: darkred;
            padding: 10px;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            border: 1px solid red;
            border-radius: 8px;
        }

        .class1 {
            display: block;
        }
        .class2 {
            display: none;
            font-weight: normal;
            font-size: 16px;
        }
        .class3 {
            display: none;
            font-weight: normal;
            font-size: 16px;
        }
        .class4 {
            display: none;
            font-weight: normal;
            font-size: x-small;
            font-family: 'Lucida Console', Courier, monospace;
            line-height: 100%;
            text-align: left;
            white-space: pre-line;
            margin-top: 6px;
        }
        .class5 {
            display: none;
            font-weight: normal;
            font-size: x-small;
            font-family: 'Lucida Console', Courier, monospace;
            line-height: 100%;
            text-align: left;
            white-space: pre-line;
            margin-top: 6px;
        }
        .class6 {
            display: none;
            font-weight: normal;
            font-size: 14px;
            line-height: 100%;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            margin-top: 6px;
            background-color: var(--backgroundColor);
        }
        .vote-count-display {
            position: absolute;
            right: 0px;
            top: 0px;
            font-size: small;
            border-left: 1px solid var(--borderColor);
            border-bottom: 1px solid var(--borderColor);
            border-bottom-left-radius: 6px;
            display: block;
            background-color: var(--backgroundColor);
            padding: 1px;
            line-height: 15px;
        }
        .vote-arrows {
            position: absolute;
            top: -6px;
            right: -14px;
            line-height: 12px;
            font-size: 16px;
            border-left: 1px solid var(--borderColor);
            border-bottom: 1px solid var(--borderColor);
            border-bottom-left-radius: 6px;
            padding-left: 1px;
            background-color: var(--backgroundColor);
            padding-bottom: 3px;
            cursor: pointer;
            transition: all 0.4s ease;
        }
        .vote-arrow-green {
            transition: all 0.4s ease;
        }
        .vote-arrow-red {
            transition: all 0.4s ease;
        }
        .vote-arrow-green:hover {
            color: lawngreen;
            transform: scale(2.5);
        }
        .vote-arrow-red:hover {
            color: red;
            transform: scale(2.5);
        }
        .vote-arrow-green-upvoted {
            color: lawngreen;
            transform: scale(1.0, 3);
            transform-origin: top;
            background-color: var(--backgroundColor);
            transition: all 0.4s ease;
        }
        .vote-arrow-red-downvoted {
            color: red;
            transform: scale(1.0, 3);
            transform-origin: bottom;
            background-color: var(--backgroundColor);
            transition: all 0.4s ease;
        }
        .vote-arrow-green-upvoted:hover {
            transform: scale(2.5, 3);
        }
        .vote-arrow-red-downvoted:hover {
            transform: scale(2.5, 3);
        }

        #promptTable {
            width: 100%;
            border-spacing: 10px;
            border-collapse: separate;
            vertical-align: top;
        }
        td {
            padding: 12px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
        }
        .prompt-row {
            font-style: italic;
            background-image: linear-gradient(var(--backgroundColor), var(--emphasisBackgroundColor), var(--backgroundColor));
            text-align: center;
            position: sticky;
            top: var(--headerRow-height);
            z-index: 1;
            line-height: unset;
            max-height: 28px;
            overflow-y: hidden;
            padding: 0%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .promptCell {
            padding-left: 10%;
            padding-right: 10%;
            padding-top: 12px;
            padding-bottom: 12px;
            max-height: 28px;
        }
        .promptCell:hover {
            max-height: unset;
        }
        #promptTable thead th {
            position: sticky;
            top: 0;
            background-color: var(--emphasisBackgroundColor);
            z-index: 2;
        }
        .table-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            overflow-y: auto;
            table-layout: fixed;
            word-break: break-word;
        }
        .headerElement {
            padding: 8px;
            width: 2%;
            border-bottom: 1px solid var(--borderColor);
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight:normal;
            font-size: 18px;
        }
        #headerRow {
            text-align: center;
            vertical-align: top;
        }
        .response-row {
            vertical-align: top;
            background-color: var(--emphasisBackgroundColor);
            transition: background-color 0.5s ease-in-out;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            top: -8px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #F0F0F0;
            -webkit-transition: .4s;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #888888;
            -webkit-transition: .4s;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #606060;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px gray;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        .dropdown-content {
            color: var(--textColor);
            background-color: var(--emphasisBackgroundColor);
            display: block;
            position: absolute;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            padding: 10px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            top: 40px;
            width: 120px;
        }
        .dropdown-content button {
            margin: 6px;
        }
        .dropdown-content a {
            color: var(--textColor);
            background-color: var(--emphasisBackgroundColor);
            text-decoration: none;
            font-weight: normal;
            display: inline-block;
            border: 1px solid var(--borderColor);

            cursor: pointer;
            font-size: 24px;
            border-radius: 8px;
            height: 44px;
            width: 44px;
            padding-top: 10px;
        }
        .dropdown-content a:hover {
            background-color: var(--backgroundColor);
        }
        .dropdown-content-narrow {
            display: inline-block;
            width: 40px;
            text-align: center;
            margin-bottom: 10px;
        }
        .dropdown-content-plusminus {
            display: inline-block;
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 150%;
            padding-top: 12px;
        }

        details {
            padding: 0;
        }
        summary {
            font-weight: bold;
            margin: 0;
            padding: 0;
            height: 24px;
            width: 24px;
            position: absolute;
        }
        details[open] {
            padding: 0;
        }
        details[open] summary {
            padding: 0;
        }

        a {
            border: 1px solid var(--borderColor);
            border-radius: 8px;
        }

        .red-shadow {
            text-shadow: 0 0 1px #FF0000;
        }

        .center {
            text-align: center;
            vertical-align: middle;
        }

        .speedometer {
            padding: 0;
            margin-top: -8px;
            font-size: x-small;
            width: 100%;
            border-bottom: 1px solid var(--borderColor);
            display: flex;
            position: relative;
            justify-content: space-between;
            white-space: normal;
            top: 0;
            bottom: 0;
            font-family: Verdana, Arial, Tahoma, sans-serif;
            text-align: center;
        }
        .speedo-status {
            display: flex;
            line-height: 12px;
        }

.mask {
    position: relative;
    overflow: hidden;
    display: flex;
    width: 60px;
    height: 30px;
    margin: 2px;
    justify-content: center;
}
.ttft-semi-circle {
    position: relative;
    display: block;
    width: 60px;
    height: 30px;
    background: linear-gradient(to right, green 0%, gray 50%, red 100%);
    border-radius: 50% 50% 50% 50% / 100% 100% 0% 0% ;
}
.tokpersec-semi-circle {
    position: relative;
    display: block;
    width: 60px;
    height: 30px;
    background: linear-gradient(to right, red 0%, gray 50%, green 100%);
    border-radius: 50% 50% 50% 50% / 100% 100% 0% 0% ;
}
.semi-circle-after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    display: block;
    width: 56px;
    height: 28px;
    margin-left: -28px;
    background: var(--emphasisBackgroundColor);
    border-radius: 50% 50% 50% 50% / 100% 100% 0% 0% ;
}
.ttft-gauge-pointer {
    position: absolute;
    top: 16px;
    left: 0px;
    width: 60px;
    height: 28px;
    background: transparent;
    transform: rotate(90deg) translate3d(0,0,0);
    transform-origin: center center;
    backface-visibility: hidden;
    transition: all .3s ease-in-out;
    text-align: left;
    vertical-align: middle;
}
.tokpersec-gauge-pointer {
    position: absolute;
    top: 16px;
    left: 0px;
    width: 60px;
    height: 28px;
    background: transparent;
    transform: rotate(90deg) translate3d(0,0,0);
    transform-origin: center center;
    backface-visibility: hidden;
    transition: all .3s ease-in-out;
    text-align: left;
    vertical-align: middle;
}

.gaugeValue-adjustment {
    position: absolute;
    display: block;
    width: 64px;
    top: 14px;
    text-align: center;
}

.float-left {
    float: left;
}
.float-right {
    float: right;
}

#logoBtn {
    position: fixed;
    left: 30px;
    bottom: 10px;
    background: url(/images/favicon/logo-bw-44x44.png) no-repeat;
    background-size: cover;
}
#logoBtn:hover {
    background: url(/images/favicon/logo-color-44x44.png) no-repeat;
    background-size: cover;
}

.position-switch-lower {
    margin-top: 5px;
    top: -3px;
}

.closebtn {
    color: darkred;
    font-weight: bold;
    float: right;
    font-size: 22px;
    line-height: 20px;
    width: 20px;
    cursor: pointer;
    transition: 0.3s;
    position: absolute;
    border-left: 1px solid var(--borderColor);
    border-bottom: 1px solid var(--borderColor);
    right: 0px;
    text-align: center;
    top: 0px;
    right: 0px;
}
.closebtn:hover {
    color: red;
}

.addItemForm-left {
    display: grid; 
    gap: 20px;
    width: 325px;
}
.vertical-row {
    position: relative;
    width: 1px;
    background-color: var(--borderColor);
}
.addItemForm-right {
    display: grid; 
    gap: 20px;
    min-width: 325px;
}
input[type='text'] {
    font-size: 18px;
}
input[type='password'] {
    font-size: 18px;
}
input[type='select'] {
    font-size: 18px;
}
.select-class {
    font-size: 18px;
    max-height: 322px;
    overflow-y: scroll;
    background-color: var(--emphasisBackgroundColor);
    color: var(--textColor);
}
.current-saved-adjustment {
    padding-left: 20px;
    margin-top: -12px;
}

.nightmode-color-changer {
    background-color: var(--emphasisBackgroundColor);
    color: var(--textColor);
    border: 1px solid var(--borderColor);
    transition: background-color 0.5s ease-in-out;
    border-radius: 6px;
}

#modelListSaved {
    position: block;
    width: 100%;
}
#modelListTemplates {
    display: none;
    width: 100%;
}

#newItemProvider {
    font-size: 18px;
    width: 100%;
    border: 0px;
    text-align: center;
}

.dropdownModelOptionsSelect {
  position: relative;
  display: inline-block;
}
#ModelOptionsSelect {
  padding: 5px;
  top: 0px;
  position: absolute;
  width: 100%;
  height: 25px;
  font-size: 18px;
}
#newItemModel {
  padding: 5px;
  top: -2px;
  position: relative;
  width: calc(100% - 29px);
  height: 13px;
  border-radius: 6px 0px 0px 6px;
}
#newItemParameters {
    resize: vertical;
    max-height: 350px;
    min-height: 91px;
}
#newItemSystemPrompt {
    resize: vertical;
    max-height: 350px;
    min-height: 91px;
}


</style>
</head>
<body>
    <div class="table-container" id="table-container">
        <table id="promptTable">
            <thead>
                <tr id="headerRow">
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <button id="logoBtn" class="button" title="Synthonnel Parley"></button>

    <button id="addItemBtn" class="button" title="Activate or Delete Models">+</button>
    <div id="addItemFormHider">
        <div id="addItemForm">
            <div id="message">Disappearing message</div>
            <div class="addItemForm-left">
                <span class="closebtn" onclick="this.parentElement.parentElement.parentElement.style.display = 'none';">&times;</span>
                <input readonly type="text" id="newItemProvider" placeholder="Choose Template" title="API Template" class="nightmode-color-changer"></input>
                <div class="dropdownModelOptionsSelect">
                    <select name="ModelOptionsSelect" id="ModelOptionsSelect" placeholder="Model" title="Model" class="nightmode-color-changer">
                    <input type="text" id="newItemModel" placeholder="Model" title="Model" class="nightmode-color-changer">
                </div>
                <textarea id="newItemSystemPrompt" placeholder="system prompt.." rows="4" title="System Prompt" class="nightmode-color-changer"></textarea>
                <input type="text" id="newItemProviderUrl" placeholder="Provider Url" title="Provider Url" class="nightmode-color-changer">
                <textarea id="newItemParameters" placeholder="parameters.." rows="4" title="Parameters" class="nightmode-color-changer"></textarea>
                <input type="password" id="newItemApiKey" placeholder="Api Key" title="Api Key" class="nightmode-color-changer">
                <input type="text" id="newItemNote" placeholder="note.." title="Note" class="nightmode-color-changer">
                <div>
                    <div style="float: left;">
                        <button id="clearForm" class="button small-text-just-wide-enough-button" onclick="clearAddItemForm();">Clear</button>
                    </div>
                    <div style="float: right;">
                        <button id="confirmAddItem" class="button small-text-just-wide-enough-button">Activate Model</button>
                    </div>
                </div>
            </div>
            <div class="vertical-row"></div>
            <div class="addItemForm-right">
                <select name="modelListSaved" id="modelListSaved" class="select-class" size="100" title="Recently Used Profiles"></select>
                <select name="modelListTemplates" id="modelListTemplates" class="select-class" size="100" title="API Template Profiles"></select>
                <div style="position: relative;">
                    <div style="position: absolute;bottom: 2px;left: 0;">
                        <label> Saved </label>
                        <label class="switch position-switch-lower">
                            <input type="checkbox" id="view-model-templates">
                            <span class="slider round"></span>
                        </label>
                        <label for="view-model-templates"> Templates </label>
                    </div>
                    <div style="position: absolute;bottom: 0;right: 0;">
                        <button id="deleteFromModelListSaved" class="button small-text-just-wide-enough-button" onclick="deleteFromSavedModelsList();">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <textarea id="userPrompt" rows="1" placeholder="Enter your message here..."></textarea>

    <button id="submitPrompt" class="button" title="Send Message">🠉</button>

    <button id="settingsBtn" class="button" title="Settings">☰</button>
    <div id="settingsFormHider">
        <div id="settingsForm">
            <span class="closebtn" onclick="this.parentElement.parentElement.style.display = 'none';">&times;</span>
            <div style="text-align: center;">
                <label style="font-size: 24px;">🌞</label>
                <label class="switch">
                    <input type="checkbox" id="darkMode">
                    <span class="slider round"></span>
                </label>
                <label style="font-size: 24px;" for="darkMode">🌛</label>
            </div>
            <hr>
            <input type="checkbox" id="check1" checked> <label for="check1">Model</label> <br>
            <input type="checkbox" id="check2"> <label for="check2">API Template</label> <br>
            <input type="checkbox" id="check3"> <label for="check3">Note</label> <br>
            <input type="checkbox" id="check4"> <label for="check4">Provider Url</label> <br>
            <input type="checkbox" id="check5"> <label for="check5">Parameters</label> <br>
            <input type="checkbox" id="check6"> <label for="check6">System Prompt</label> <br>
            <hr>
            <input type="checkbox" id="sticky-prompt" checked> <label for="sticky-prompt">Sticky Prompt</label> <br>
            <input type="checkbox" id="vote-count-checkbox" checked> <label for="vote-count-checkbox">Vote Count</label> <br>
            <div style="text-align: center;">
                <label> Plain </label>
                <label class="switch position-switch-lower">
                    <input type="checkbox" id="monospace-responses">
                    <span class="slider round"></span>
                </label>
                <label style="font-family: 'Lucida Console', Courier, monospace;" for="monospace-responses"> Monospace </label>
            </div>
            <hr>
            <!-- <button class="button small-text-wide-button" onclick="saveParleyTSV()" title="Tab Separated Values.">TSV Download</button> -->
            <button class="button small-text-wide-button" onclick="saveParleyTable()" title="Simple HTML Table.">Download as Table</button>
        </div>
    </div>

    <script>

        function deleteColumn(indexToRemove) {
            if (!confirm("Remove Model from Active List?")) {
                return;
            }

            const table = document.querySelector('#promptTable');
            const rows = table.rows;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells[0].className === 'prompt-row') {
                    continue
                }

                rows[i].deleteCell(indexToRemove);
            }

            saveAndRefreshActiveModels();
        }

        function pauseColumn(columnIndex) {
            var row = document.getElementById("headerRow");
            var cell = row.cells[columnIndex];
            var pausedVal = cell.getAttribute('data-paused');
            cell.style.transform = `scale(${pausedVal ? 1 : 0.75})`;
            cell.setAttribute('data-paused', pausedVal ? '' : 'true');
            cell.setAttribute('title', pausedVal ? '' : 'This model is paused.');
            cell.style.setProperty('font-style', pausedVal ? '' : 'italic');
            cell.style.setProperty('font-weight', pausedVal ? '' : 'lighter');
            cell.style.setProperty('text-decoration-line', pausedVal ? '' : 'line-through');

            document.querySelectorAll('details[open]').forEach(detailsElement => detailsElement.removeAttribute('open'));
        }
        
        function moveColumnLeft(cellIndex) {
            const table = document.querySelector('#promptTable');
            const rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells[0].className === 'prompt-row') {
                    continue
                }

                var targetRow = table.rows[i];
                const cells = targetRow.cells;
                const cellToMove = cells[cellIndex];

                if (cellIndex === 0) {
                    targetRow.appendChild(cellToMove);
                } else {
                    targetRow.insertBefore(cellToMove, cells[cellIndex - 1]);
                }
            }

            saveAndRefreshActiveModels();
        }

        function moveColumnRight(cellIndex) {
            const table = document.querySelector('#promptTable');
            const rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells[0].className === 'prompt-row') {
                    continue
                }

                var targetRow = table.rows[i];
                const cells = targetRow.cells;
                const cellToMove = cells[cellIndex];

                if (cellIndex === cells.length - 1) {
                    targetRow.insertBefore(cellToMove, targetRow.firstChild);
                } else {
                    targetRow.insertBefore(cells[cellIndex + 1], cellToMove);
                }
            }

            saveAndRefreshActiveModels();
        }

        function saveAndRefreshActiveModels() {
            saveItemsActiveModels();

            var row = document.getElementById("headerRow");
            cellLen = row.cells.length;

            for(index=0; index<cellLen; index++) {
                var item = row.cells[index];
                const itemData = {
                    model: item.getAttribute('data-model'),
                    provider: item.getAttribute('data-provider'),
                    note: item.getAttribute('data-note'),
                    providerUrl: item.getAttribute('data-providerUrl'),
                    systemPrompt: item.getAttribute('data-systemPrompt'),
                    parameters: item.getAttribute('data-parameters'),
                    apiKey: item.getAttribute('data-apiKey'),
                    model_options: item.getAttribute('data-model_options')                    
                };
                item = addColumn(itemData, index);
                row.cells[index].replaceWith(item);
            }
        }

        function showMessage(message) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.style.opacity = '1';

            setTimeout(() => {
                messageElement.style.opacity = '0';
            }, 3000);
        }

        function flashElementRed(element) {
            const messageElement = document.getElementById(element);
            messageElement.style.backgroundColor = '#FF8888';

            setTimeout(() => {
                messageElement.style.backgroundColor = 'inherit';
            }, 3000);
        }

        function flashElementGreen(element) {
            const messageElement = document.getElementById(element);
            messageElement.style.backgroundColor = '#88FF88';

            setTimeout(() => {
                messageElement.style.backgroundColor = 'inherit';
            }, 500);
        }

        document.getElementById('userPrompt').addEventListener('input', function(event) {
            const textAreaElement = document.getElementById('userPrompt');
            document.getElementById('submitPrompt').style.opacity = textAreaElement.value.trim().length == 0 ? '0.3' : '1';
        });

        document.getElementById('submitPrompt').addEventListener('click', function() {
            const tableContainer = document.getElementById("table-container")
            const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

            document.getElementById('submitPrompt').style.opacity = '0.3';
            const textAreaElement = document.getElementById('userPrompt');
            const prompt = textAreaElement.value.trim();
            textAreaElement.value = '';
            textAreaElement.style.height = 'auto';
            textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;

            if (!prompt) { return;}

            const table = document.querySelector('#promptTable');
            const headerRow = table.rows[0];
            const headerCells = headerRow.cells;

            const promptRow = table.insertRow(-1);
            const promptCell = promptRow.insertCell(0);
            promptCell.className = 'prompt-row';
            promptCell.colSpan = '100';

            const promptCellDiv = document.createElement('div');
            promptCellDiv.innerHTML = prompt;
            promptCellDiv.className = 'promptCell';
            promptCell.appendChild(promptCellDiv);

            const cellsToProcessTotal = Array.from(headerCells).filter(item => !item.getAttribute('data-paused')).length;
            promptCell.setAttribute("synthonnelTotal", cellsToProcessTotal);
            promptCell.setAttribute("synthonnelCount", cellsToProcessTotal);

            promptCell.title = "Running.\n" + cellsToProcessTotal + " called.\n" + cellsToProcessTotal + " still working.\n";
            promptCellDiv.style.backgroundColor = `rgba(255, 0, 0, 0.25)`;

            const ResponseRow = table.insertRow(-1);
            ResponseRow.className = 'response-row';
            
            if (isAtBottom) { tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight }

            var StartTime = new Date();
            var MaxFirstTokenDuration = 0;
            var MinFirstTokenDuration = 999999;
            var MaxTokPerSec = 0.0;
            var MinTokPerSec = 9999.9;

            Array.from(headerCells).forEach((item, index) => {
                const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

                const thisResponseCell = ResponseRow.insertCell(index);

                var pausedVal = item.getAttribute('data-paused');

                if (pausedVal) {
                    thisResponseCell.innerHTML = '~ paused ~';
                    thisResponseCell.style.transform = "scale(0.75)";
                    thisResponseCell.className = "center";
                    thisResponseCell.title = "Model paused for this prompt.";
                } else {
                    thisResponseCell.innerHTML = `<div class="speedometer">
                        <div class="float-left">
                            <div class="box ttft-gauge" title="Time to First Token in Seconds">
                                <div class="mask">
                                    <div class="ttft-semi-circle"></div>
                                    <div class="semi-circle-after"></div>
                                    <div class="ttft-gauge-pointer">🠴</div>
                                </div>
                                <div class="gaugeValue-adjustment"><span id="firsttokenValue"></span></div>
                            </div>
                        </div>
                        <span id="speedo-status" class="speedo-status"></span>
                        <div class="float-right">
                            <div class="box tokpersec-gauge" title="Tokens per Second">
                                <div class="mask">
                                    <div class="tokpersec-semi-circle"></div>
                                    <div class="semi-circle-after"></div>
                                    <div class="tokpersec-gauge-pointer">🠴</div>
                                </div>
                                <div class="gaugeValue-adjustment"><span id="tokspersecValue"></span></div>
                            </div>
                        </div>
                        <div class="vote-arrows">
                            <div id="upvote" class="vote-arrow-green" onclick="if (this.className.includes('upvoted')) {this.className='vote-arrow-green';} else {this.className='vote-arrow-green-upvoted';}; this.parentElement.children.namedItem('downvote').className='vote-arrow-red';countClassInColumns();">🠅</div>
                            <br>
                            <div id="downvote" class="vote-arrow-red" onclick="if (this.className.includes('downvoted')) {this.className='vote-arrow-red';} else {this.className='vote-arrow-red-downvoted';}; this.parentElement.children.namedItem('upvote').className='vote-arrow-green';countClassInColumns();">🠇</div>
                        </div>
                    </div><div class="raw-text"></div>`;

                    thisResponseCell.querySelector('#speedo-status').innerHTML = `Preparing Request..`;
                    thisResponseCell.style = 'border: 2px solid red;';

                    const ws = new WebSocket(`ws://localhost:8000/ws/stream-llm-response`);

                    const tableFresh = document.querySelector('#promptTable');

                    var messages = [];

                    if (item.getAttribute('data-systemPrompt')) {
                        messages.push({"role": "system", "content": item.getAttribute('data-systemPrompt').trim()});
                    }

                    for (var i = 1; i < tableFresh.rows.length - 1; i++) {
                        var rowFresh = tableFresh.rows[i];
                        var role = '';
                        var content = '';

                        if ( rowFresh.cells[0].className === 'prompt-row' ) {
                            role = 'user';
                            content = rowFresh.cells[0].textContent.trim();
                        } else {
                            if ( rowFresh.cells[index].querySelector('.raw-text') ) {
                                role = 'assistant';
                                content = rowFresh.cells[index].querySelector('.raw-text').textContent.trim();
                            }
                        }

                        if (content.length > 0) {
                            messages.push({"role": role, "content": content});
                        }
                    }

                    var tokenCount = 0;
                    var firstTokenTime = new Date();
                    var tokensPerSecond = 0;
                    
                    if (isAtBottom) { tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight }

                    ws.onopen = function(event) {
                        const itemData = {
                            messages: messages,
                            model: item.getAttribute('data-model'),
                            note: item.getAttribute('data-note'),
                            provider: item.getAttribute('data-provider'),
                            providerUrl: item.getAttribute('data-providerUrl'),
                            parameters: item.getAttribute('data-parameters'),
                            apiKey: item.getAttribute('data-apiKey')
                        };
                        ws.send(JSON.stringify(itemData));

                        thisResponseCell.querySelector('#speedo-status').innerHTML = `Awaiting Reply..`;
                        console.log("WebSocket connection opened for", item.getAttribute('data-provider'));
                    };

                    ws.onmessage = function(event) {
                        tokenCount++;
                        const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;
                        thisResponseCell.querySelector('#speedo-status').innerHTML = `Receiving..<br>Tokens: ${tokenCount}`;

                        thisResponseCell.querySelector('.raw-text').textContent += event.data;

                        if (tokenCount == 1) {
                            firstTokenTime = new Date();
                            var firstTokenDurn = firstTokenTime - StartTime;
                            thisResponseCell.querySelector('#firsttokenValue').textContent = `${(firstTokenDurn / 1000).toFixed(2)}`;
                            thisResponseCell.querySelector('#speedo-status').innerHTML = `Received: 1 Token`;

                            MaxFirstTokenDuration = Math.max(MaxFirstTokenDuration, firstTokenDurn);
                            MinFirstTokenDuration = Math.min(MinFirstTokenDuration, firstTokenDurn);

                            reDrawTimeFirstTokenPointers();
                        } else {
                            const now = new Date();
                            const elapsedTime = (now - firstTokenTime) / 1000;
                            tokensPerSecond = tokenCount / elapsedTime;
                            thisResponseCell.querySelector('#tokspersecValue').textContent = `${(tokensPerSecond).toFixed(2)}`;
                            thisResponseCell.querySelector('#speedo-status').innerHTML = `Receiving..<br>${tokenCount} t / ${elapsedTime.toFixed(2)} s`;
                            thisResponseCell.querySelector('#speedo-status').title = `Receiving..\nTokens: ${tokenCount}t\nRuntime: ${elapsedTime.toFixed(2)}s`;

                            MaxTokPerSec = Math.max(MaxTokPerSec, tokensPerSecond);
                            MinTokPerSec = Math.min(MinTokPerSec, tokensPerSecond);

                            reDrawTokPerSecPointers();
                        }

                        if (isAtBottom) { tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight }
                    };

                    ws.onerror = function(event) {
                        const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;
                        thisResponseCell.querySelector('.raw-text').textContent += event.data;
                        if (isAtBottom) { tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight }
                        console.error("WebSocket error observed:", event);
                    };

                    ws.onclose = function(event) {
                        nowTime = new Date();
                        runTime = nowTime - StartTime;
                        thisResponseCell.querySelector('#speedo-status').innerHTML = `Complete.<br>${tokenCount} t / ${(runTime / 1000).toFixed(2)} s`;
                        thisResponseCell.querySelector('#speedo-status').title = `Complete.\nTokens: ${tokenCount}\nRuntime: ${(runTime / 1000).toFixed(2)}`;
                        thisResponseCell.style = ``;
                        resetTokpersecMinMax();

                        promptCell.setAttribute("synthonnelCount", parseInt(promptCell.getAttribute("synthonnelCount") - 1));
                        if (parseInt(promptCell.getAttribute("synthonnelCount")) < 1) {
                            promptCell.title = "Complete.\n" + cellsToProcessTotal + " called.\n" + "0 still working.\n";
                            promptCellDiv.style.backgroundColor = "lawngreen";

                            setTimeout(() => {
                                promptCellDiv.style.transition = "background-color 1s ease-out";
                                promptCellDiv.style.backgroundColor = 'unset';
                            }, 10);
                        } else {
                            promptCell.title = "Running.\n" + 
                                promptCell.getAttribute("synthonnelTotal") + " called.\n" + 
                                promptCell.getAttribute("synthonnelCount") + " still working.\n";
                        }

                        console.log("WebSocket connection closed for", item.getAttribute('data-provider'));
                    };


                    function reDrawTimeFirstTokenPointers() {
                            Array.from(ResponseRow.cells).forEach((item, index) => {
                                const tempCell = ResponseRow.cells[index];

                                if (tempCell.querySelector("#tokspersecValue")) {
                                    var tempFirstTok = parseFloat(tempCell.querySelector("#firsttokenValue").textContent);

                                    if (!isNaN(tempFirstTok)) {
                                        tempFirstTok *= 1000;

                                        const pctTime = (MaxFirstTokenDuration == MinFirstTokenDuration) 
                                                        ? 0.5
                                                        : (tempFirstTok - MinFirstTokenDuration) / (MaxFirstTokenDuration - MinFirstTokenDuration);

                                        const newVal = 10 + Math.floor(pctTime * 160);
                                        tempCell.querySelector('.ttft-gauge .ttft-gauge-pointer').setAttribute('style', '-webkit-transform: rotate(' + newVal + 'deg);' + '-moz-transform: rotate(' + newVal + 'deg);' + 'transform: rotate(' + newVal + 'deg);');
                                    }
                                }
                            });

                    }

                    function reDrawTokPerSecPointers() {
                            Array.from(ResponseRow.cells).forEach((item, index) => {
                                const tempCell = ResponseRow.cells[index];

                                if (tempCell.querySelector("#tokspersecValue")) {
                                    const tempTokPerSec = parseFloat(tempCell.querySelector("#tokspersecValue").textContent);

                                    if (!isNaN(tempTokPerSec)) {
                                        var pctTime = (MaxTokPerSec == MinTokPerSec) 
                                                        ? 0.5
                                                        : (tempTokPerSec - MinTokPerSec) / (MaxTokPerSec - MinTokPerSec);

                                        var newVal = 10 + Math.floor(pctTime * 160);
                                        tempCell.querySelector('.tokpersec-gauge .tokpersec-gauge-pointer').setAttribute('style', '-webkit-transform: rotate(' + newVal + 'deg);' + '-moz-transform: rotate(' + newVal + 'deg);' + 'transform: rotate(' + newVal + 'deg);');
                                    }
                                }
                            });

                    }

                    function resetTokpersecMinMax() {
                        MaxTokPerSec = 0.0;
                        MinTokPerSec = 9999.9;

                        Array.from(ResponseRow.cells).forEach((item, index) => {
                            const tempCell = ResponseRow.cells[index];

                            if (tempCell.querySelector("#tokspersecValue")) {
                                const thisTokensPerSecond = parseFloat(tempCell.querySelector("#tokspersecValue").textContent);

                                if (thisTokensPerSecond) {
                                    MaxTokPerSec = Math.max(MaxTokPerSec, thisTokensPerSecond);
                                    MinTokPerSec = Math.min(MinTokPerSec, thisTokensPerSecond);
                                }
                            }
                        });

                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            loadTemplateModelsList();
            ModelOptionsSelect.disabled = true;

            function toggleVisibility(checkboxId, className) {
                const checkbox = document.getElementById(checkboxId);
                checkbox.addEventListener('change', function() {
                    const styleSheet = document.createElement("style");
                    document.head.appendChild(styleSheet);

                    if (checkbox.checked) {
                        styleSheet.sheet.insertRule(`.${className} { display: block; }`, 0);
                    } else {
                        styleSheet.sheet.insertRule(`.${className} { display: none; }`, 0);
                    }
                });
            }

            toggleVisibility('check1', 'class1');
            toggleVisibility('check2', 'class2');
            toggleVisibility('check3', 'class3');
            toggleVisibility('check4', 'class4');
            toggleVisibility('check5', 'class5');
            toggleVisibility('check6', 'class6');
            toggleVisibility('vote-count-checkbox', 'vote-arrows');
            toggleVisibility('vote-count-checkbox', 'vote-count-display');
        });

        function loadModels() {
            fetch('http://localhost:8000/get-items-active')
                .then(response => response.json())
                .then(data => {
                    const headerRow = document.getElementById('headerRow');

                    data.forEach((item, index) => {
                        const th = addColumn(item, index);
                        headerRow.appendChild(th);
                    });
                })
                .catch(error => console.error('Error loading table header data:', error));
        }

        function addColumn(item, index) {
            const th = document.createElement('th');
            th.className = 'headerElement';
            th.textContent = item.provider;
            th.title = `Model: ${item.model}\nAPI Template: ${item.provider}\nNote: ${item.note}\nProvider URL: ${item.providerUrl}\nParameters: ${item.parameters}\nSystem Prompt: ${item.systemPrompt}`;
            th.innerHTML = `
                <details name="menu">
                    <summary></summary>
                    <div class="dropdown-content">
                        <button class="button" onclick="moveColumnLeft(${index})" title="Move Left">🢀</button>
                        <button class="button" onclick="moveColumnRight(${index})" title="Move Right">🢂</button>
                        <button class="button-wide" onclick="pauseColumn(${index})" title="Pause / Active">⏯️</button> <br>
                        <button class="button-wide" onclick="deleteColumn(${index})" title="Delete Model">❌</button>
                    </div>
                </details>

                <div class="class1" title="Model Name">${item.model}</div>
                <div class="class2" title="API Template">${item.provider}</div>
                <div class="class3" title="Note">${item.note}</div>
                <div class="class4" title="Provider URL">${item.providerUrl}</div>
                <div class="class5" title="Parameters">${item.parameters}</div>
                <div class="class6" title="System Prompt">${item.systemPrompt}</div>
                <div class="vote-count-display" id="vote-count-display" title="Vote Count">0</div>
            `;

            th.setAttribute('data-model', item.model);
            th.setAttribute('data-provider', item.provider);
            th.setAttribute('data-note', item.note);
            th.setAttribute('data-providerUrl', item.providerUrl);
            th.setAttribute('data-systemPrompt', item.systemPrompt);
            th.setAttribute('data-parameters', item.parameters);
            th.setAttribute('data-apiKey', item.apiKey);
            th.setAttribute('data-model_options', item.model_options);

            return th;
        }

        document.getElementById('addItemBtn').onclick = function() {
            if (document.getElementById('addItemFormHider').style.display == 'block') {
                document.getElementById('addItemFormHider').style.display = 'none';
            } else {
                document.getElementById('addItemFormHider').style.display = 'block';
                loadSavedModelsList();
            }
        };

        document.getElementById('settingsBtn').onclick = function() {
            if (document.getElementById('settingsFormHider').style.display == 'block') {
                document.getElementById('settingsFormHider').style.display = 'none';
            } else {
                document.getElementById('settingsFormHider').style.display = 'block';
            }
        };

        document.getElementById('darkMode').onchange = function() {
            if (document.getElementById('darkMode').checked) {
                document.documentElement.style.setProperty('--backgroundColor', '#2F2F2F');
                document.documentElement.style.setProperty('--textColor', '#F0F0F0');
                document.documentElement.style.setProperty('--emphasisBackgroundColor', '#000000');
                document.documentElement.style.setProperty('--borderColor', '#606060');
            } else {
                document.documentElement.style.setProperty('--backgroundColor', '#F0F0F0');
                document.documentElement.style.setProperty('--textColor', '#0F0F0F');
                document.documentElement.style.setProperty('--emphasisBackgroundColor', '#FFFFFF');
                document.documentElement.style.setProperty('--borderColor', '#C0C0C0');
            }
        };

        document.getElementById('monospace-responses').onchange = function() {
            const styleSheet = document.createElement("style");
            document.head.appendChild(styleSheet);

            if (document.getElementById('monospace-responses').checked) {
                styleSheet.sheet.insertRule(`.response-row { white-space: pre-wrap; }`, 0);
                styleSheet.sheet.insertRule(`.response-row { font-family: monospace; }`, 0);
            } else {
                styleSheet.sheet.insertRule(`.response-row { white-space: initial; }`, 0);
                styleSheet.sheet.insertRule(`.response-row { font-family: unset; }`, 0);
            }
        };

        document.getElementById('view-model-templates').onchange = function() {
            if (document.getElementById('view-model-templates').checked) {
                document.getElementById('modelListSaved').style.display = 'none';
                document.getElementById('modelListTemplates').style.display = 'block';

                document.querySelector('#deleteFromModelListSaved').disabled = true;
                document.getElementById('deleteFromModelListSaved').style.opacity = '0.0';


            } else {
                document.getElementById('modelListSaved').style.display = 'block';
                document.getElementById('modelListTemplates').style.display = 'none';

                document.querySelector('#deleteFromModelListSaved').removeAttribute("disabled");
                document.getElementById('deleteFromModelListSaved').style.opacity = '';

            }
        };

        document.getElementById('confirmAddItem').onclick = async function() {
            const item = {
                model: document.getElementById('newItemModel').value.trim(),
                provider: document.getElementById('newItemProvider').value.trim(),
                note: document.getElementById('newItemNote').value.trim(),
                providerUrl: document.getElementById('newItemProviderUrl').value.trim(),
                systemPrompt: document.getElementById('newItemSystemPrompt').value.trim(),
                parameters: document.getElementById('newItemParameters').value.trim(),
                apiKey: document.getElementById('newItemApiKey').value.trim()
            };

            if (!(item.provider && item.model && item.providerUrl && item.apiKey)) {
                showMessage("Missing required fields:");

                if (!item.model) { flashElementRed("newItemModel"); }
                if (!item.providerUrl) { flashElementRed("newItemProviderUrl"); }
                if (!item.provider) { flashElementRed("newItemProvider"); }
                if (!item.apiKey) { flashElementRed("newItemApiKey"); }

                return;
            } 

            const headerCells = document.querySelectorAll('#promptTable thead th');
            const itemIsActive = Array.from(headerCells).some(th => 
                th.getAttribute('data-model') === item.model &&
                th.getAttribute('data-provider') === item.provider &&
                th.getAttribute('data-note') === item.note &&
                th.getAttribute('data-providerUrl') === item.providerUrl &&
                th.getAttribute('data-systemPrompt') === item.systemPrompt &&
                th.getAttribute('data-parameters') === item.parameters &&
                th.getAttribute('data-apiKey') === item.apiKey
            );

            if (itemIsActive) {
                showMessage("This model is already active.");
                return;
            }

            const headerRow = document.getElementById('headerRow');
            const th = addColumn(item, headerRow.cells.length);
            headerRow.appendChild(th);

            const table = document.querySelector('#promptTable');
            const rows = table.rows;
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].cells[0].className === 'prompt-row') {
                    continue
                }

                const newRow = rows[i];
                const newCell = newRow.insertCell(-1);
                newCell.innerHTML = '~ null ~';
                newCell.style.transform = "scale(0.75)";
                newCell.className = "center";
                newCell.title = "This model was not yet added for this prompt.";
            }

            const selectElement = document.getElementById("modelListSaved");
            const itemDataString = JSON.stringify(item);

            const itemSavedExists = Array.from(selectElement.options).some(opt => 
                JSON.parse(opt.dataset.itemData)['model'] === item.model &&
                JSON.parse(opt.dataset.itemData)['provider'] === item.provider &&
                JSON.parse(opt.dataset.itemData)['note'] === item.note &&
                JSON.parse(opt.dataset.itemData)['providerUrl'] === item.providerUrl &&
                JSON.parse(opt.dataset.itemData)['systemPrompt'] === item.systemPrompt &&
                JSON.parse(opt.dataset.itemData)['parameters'] === item.parameters &&
                JSON.parse(opt.dataset.itemData)['apiKey'] === item.apiKey
            );

            if (!itemSavedExists) {
                const option = new Option(item.model + " / " + item.provider, JSON.stringify(item));
                option.dataset.itemData = itemDataString;
                option.title = `${item.model}\n${item.provider}\n${item.note}\n${item.providerUrl}\n${item.parameters}\n`;
                selectElement.appendChild(option);
                saveSavedModelList();
            }

            saveItemsActiveModels();
        };

        async function saveItemsActiveModels() {
            const headerCells = document.querySelectorAll('#promptTable thead th');

            const items = Array.from(headerCells).map(th => ({
                provider: th.getAttribute('data-provider'),
                model: th.getAttribute('data-model'),
                parameters: th.getAttribute('data-parameters'),
                providerUrl: th.getAttribute('data-providerUrl'),
                systemPrompt: th.getAttribute('data-systemPrompt'),
                apiKey: th.getAttribute('data-apiKey'),
                note: th.getAttribute('data-note'),
                model_options: th.getAttribute('data-model_options'),                
            }));

            fetch('http://localhost:8000/save-items-active', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Items saved successfully.");
                } else {
                    console.error("Failed to save items.");
                    showMessage("Failed to save items.");
                }
            })
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            const textarea = document.getElementById('userPrompt');
            
            function autoGrowTextArea(textAreaElement) {
                textAreaElement.style.height = 'auto';
                textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;
            }
            
            textarea.addEventListener('input', function() {
                autoGrowTextArea(this);
            });

            autoGrowTextArea(textarea);

            document.getElementById("ModelOptionsSelect").addEventListener('change', function () {
                    document.getElementById('newItemModel').value = document.getElementById("ModelOptionsSelect").value;
                    document.getElementById("ModelOptionsSelect").value = '';
                });
        });

        async function loadSavedModelsList() {
            const loader = ms => new Promise(res => setTimeout(res, ms));
            const selectElement = document.getElementById("modelListSaved");
            selectElement.length = 0;
            await loader(100);

            fetch('http://localhost:8000/get-items-saved')
                .then(response => response.json())
                .then(data => {
                    const itemDataList = [];
                    data.forEach((item, index) => {
                        const itemData = {
                            provider: item.provider,
                            model: item.model,
                            parameters: item.parameters,
                            providerUrl: item.providerUrl,
                            systemPrompt: item.systemPrompt,
                            apiKey: item.apiKey,
                            note: item.note
                        };
                        itemDataList.push(itemData);

                        const uniqueId = `item-${index}`;
                        const option = new Option(itemData.model + " / " + itemData.provider + " / " + itemData.note, uniqueId);
                        option.title = `${itemData.model}\n${itemData.provider}\n${itemData.note}\n${itemData.providerUrl}\n${itemData.parameters}\n`;
                        option.dataset.itemData = JSON.stringify(itemData);
                        selectElement.appendChild(option);
                    });

                    selectElement.addEventListener("change", function() {
                        const selectedItemId = this.value;
                        const itemData = JSON.parse(this.querySelector(`[value="${selectedItemId}"]`).dataset.itemData);
                        optionClicked(itemData);
                    });
                })
                .catch(error => console.error('Error loading data:', error));
        }

        async function loadTemplateModelsList() {
            const selectElement = document.getElementById("modelListTemplates");
            selectElement.length = 0;

            fetch('http://localhost:8000/get-items-templates')
                .then(response => response.json())
                .then(data => {
                    const itemDataList = [];
                    data.forEach((item, index) => {
                        const itemData = {
                            provider: item.provider,
                            model: item.model,
                            parameters: item.parameters,
                            providerUrl: item.providerUrl,
                            systemPrompt: item.systemPrompt,
                            apiKey: item.apiKey,
                            note: item.note,
                            model_options: item.model_options
                        };
                        itemDataList.push(itemData);

                        const uniqueId = `template-item-${index}`;
                        const option = new Option(itemData.provider, uniqueId);
                        option.title = `${itemData.model}\n${itemData.provider}\n${itemData.note}\n${itemData.providerUrl}\n${itemData.parameters}\n`;
                        option.dataset.itemData = JSON.stringify(itemData);
                        selectElement.appendChild(option);
                    });

                    selectElement.addEventListener("change", function() {
                        const selectedItemId = this.value;
                        const itemData = JSON.parse(this.querySelector(`[value="${selectedItemId}"]`).dataset.itemData);
                        optionClicked(itemData);
                    });
                })
                .catch(error => console.error('Error loading data:', error));
        }

        async function loadAPITemplates() {
            const selectElement = document.getElementById("newItemProvider");
            selectElement.length = 0;
            const option = new Option("", "");
            const response = await fetch("http://localhost:8000/get-api-templates");
            const data = await response.json();

            for (const func of data) {
                const option = new Option(func.friendly_name, func.id);
                selectElement.appendChild(option);
            }
        }

        async function loadModelOptions(model_options) {
            const selectElement = document.getElementById("ModelOptionsSelect");
            selectElement.length = 0;
            selectElement.disabled = !model_options;

            if (model_options) {
                const option = new Option("", "");
                selectElement.appendChild(option);

                model_options.forEach((item, index) => {
                    const option = new Option(item, item);
                    selectElement.appendChild(option);
                });
            }
        }

        function optionClicked (item) {
            function setAndFlash(newItemParameter, item_value) {
                modelWas = document.getElementById(newItemParameter).value;
                document.getElementById(newItemParameter).value = item_value;
                if (!(modelWas === item_value)) {
                    flashElementGreen(newItemParameter);
                }
            }

            loadModelOptions(item.model_options);

            setAndFlash("newItemModel", item.model)
            setAndFlash("newItemProvider", item.provider)
            setAndFlash("newItemProviderUrl", item.providerUrl)
            setAndFlash("newItemSystemPrompt", item.systemPrompt)            
            setAndFlash("newItemParameters", item.parameters)
            setAndFlash("newItemApiKey", item.apiKey)
            setAndFlash("newItemNote", item.note)
        }

        function deleteFromSavedModelsList() {
            const selectElement = document.getElementById("modelListSaved");
            const selectedIndex = selectElement.selectedIndex;

            if (selectedIndex !== -1) {
                if (!confirm("Permanently Delete Model Profile?")) {
                    return;
                }
                selectElement.remove(selectedIndex);

                saveSavedModelList();
            }
        }

        function saveSavedModelList() {
            const selectElement = document.getElementById("modelListSaved");
            const itemDataList = Array.from(selectElement.options).map(option => JSON.parse(option.dataset.itemData));

            fetch('http://localhost:8000/save-items-saved', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(itemDataList),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Items saved successfully.");
                } else {
                    console.error("Failed to save items.");
                    showMessage("Failed to save items.");
                }
            })
            .catch(error => console.error('Error:', error));

            loadSavedModelsList();
        }

        function clearAddItemForm() {
            document.getElementById("newItemModel").value = '';
            document.getElementById("newItemProvider").value = '';
            document.getElementById("newItemProviderUrl").value = '';
            document.getElementById("newItemSystemPrompt").value = '';            
            document.getElementById("newItemParameters").value = '';
            document.getElementById("newItemApiKey").value = '';
            document.getElementById("newItemNote").value = '';
        }

        function adjustHeaderRowHeight() {
            const firstDiv = document.getElementById('headerRow');
            const firstDivRect = firstDiv.getBoundingClientRect();
            const secondDivTop = firstDivRect.height;
            document.documentElement.style.setProperty('--headerRow-height', `${secondDivTop}px`);
        }

        const headerRowHeightObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                adjustHeaderRowHeight();
            }
        });

        headerRowHeightObserver.observe(document.getElementById('headerRow'));

        document.getElementById('sticky-prompt').addEventListener('change', function() {
            const checkbox = document.getElementById('sticky-prompt');

            if (checkbox.checked) {
                headerRowHeightObserver.observe(document.getElementById('headerRow'));
                adjustHeaderRowHeight();
            } else {
                headerRowHeightObserver.unobserve(document.getElementById('headerRow'));
                document.documentElement.style.setProperty('--headerRow-height', `-1000px`);
            }
        });

        function saveParleyTSV() {
            var table = document.getElementById("promptTable");
            var tsvData = "";
            var headerRow = document.getElementById("headerRow");
            cellLen = headerRow.cells.length;

            tsvData += escapeForTSV("model");
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                tsvData += "\t" + escapeForTSV(item.getAttribute('data-model'));
            }

            tsvData += "\n";
            tsvData += escapeForTSV("provider");
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                tsvData += "\t" + escapeForTSV(item.getAttribute('data-provider'));
            }

            tsvData += "\n";
            tsvData += escapeForTSV("note");
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                tsvData += "\t" + escapeForTSV(item.getAttribute('data-note'));
            }

            tsvData += "\n";
            tsvData += escapeForTSV("providerUrl");
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                tsvData += "\t" + escapeForTSV(item.getAttribute('data-providerUrl'));
            }

            tsvData += "\n";
            tsvData += escapeForTSV("parameters");
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                tsvData += "\t" + escapeForTSV(item.getAttribute('data-parameters'));
            }

            for (var rowLoop = 1; rowLoop < table.rows.length; rowLoop++) {
                tsvData += "\n";
                if ( table.rows[rowLoop].cells[0].className === 'prompt-row' ) {
                    tsvData += escapeForTSV("Prompt") + "\t";
                    tsvData += escapeForTSV(table.rows[rowLoop].cells[0].querySelector('.promptCell').innerHTML);

                    tsvData += '\t'.repeat(cellLen-1);
                } else {
                    if ( table.rows[rowLoop].cells[0].className === 'response-row' ) {
                        tsvData += escapeForTSV("Responses");
                    } else {
                        tsvData += escapeForTSV("Unknown");
                    }

                    for(cellLoop=1; cellLoop<cellLen; cellLoop++) {
                        rawText = table.rows[rowLoop].cells[cellLoop].querySelector('.raw-text').innerHTML;
                        tsvData += "\t" + escapeForTSV(rawText);
                    }
                }

            }

            var blob = new Blob([tsvData], { type: "text/csv;charset=utf-8" });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Synthonnel_Parley_" + getFormattedDateTimeUnderscores() + ".tsv";
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        function saveParleyTable() {
            var table = document.getElementById("promptTable");
            htmlData = "<html>\n";

            htmlData += `
<html>
  <head>
    <title>Synthonnel Parley ${getFormattedDateTimePolite()}</title>
    <style>

table {
  border-collapse: collapse;
  font-family: Verdana, Arial, Tahoma, sans-serif;
  padding: 10px;
  table-layout: fixed;
  width: fit-content;
}
thead {
  vertical-align: top;
}
th {
  border: 1px solid purple;
  padding: 10px;
  text-align: left;
}
tbody {
  vertical-align: top;
  line-height: 175%;
  text-align: left;
}
table td {
  border: 1px solid blue;
  padding: 10px;
}
.table-container {
  overflow-x: auto;
}        

.small-courier {
  font-size: small;
  font-family: Courier, monospace;
  white-space: pre-line;
  font-weight: lighter;
  line-height: normal;
}
.resize {
  resize: vertical;
  overflow: auto;
}
.prompt-row {
  font-style: italic;
}
.normal {
  font-weight: normal;
  line-height: normal;
}
.no-border-spacer {
  border: 0px;
  height: 2px;
}
.sticky {
  position: sticky;
  top: 0;
  background-color: #f0f0f0;

}

    </style>
    </head>
        <table>
            <caption><p>Synthonnel Parley - ${getFormattedDateTimePolite()}<p></caption>
            <thead>
`;

            var headerRow = document.getElementById("headerRow");
            cellLen = headerRow.cells.length;

            htmlData += "<tr class='sticky '>\n";
            htmlData += `  <th style='width: 100px' class='normal '>Model:</th>\n`;
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += `  <th style='width: ${Math.max(1600 / cellLen, 300)}px;' class='normal '>${item.getAttribute('data-model')}</th>\n`;
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='normal '>Provider:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='normal '>" + item.getAttribute('data-provider') + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='normal '>Note:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='normal '>" + item.getAttribute('data-note') + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='small-courier '>ProviderUrl:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='small-courier'>" + item.getAttribute('data-providerUrl') + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='small-courier '>Parameters:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='small-courier'>" + item.getAttribute('data-parameters') + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='normal '>System Prompt:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='normal '>" + item.getAttribute('data-systemPrompt') + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "<tr>\n";
            htmlData += "  <th class='normal '>Votes:</th>\n";
            for(index=0; index<cellLen; index++) {
                var item = headerRow.cells[index];
                htmlData += "  <th class='small-courier '>" + item.querySelector('#vote-count-display').title + "</th>\n";
            }
            htmlData += "</tr>\n";

            htmlData += "</thead>\n";
            htmlData += "<tbody>\n";

            // Loop through prompt/response rows
            for (var rowLoop = 1; rowLoop < table.rows.length; rowLoop++) {
                if ( table.rows[rowLoop].cells[0].className === 'prompt-row' ) {
                    htmlData += "<tr>\n";
                    htmlData += "  <td class='no-border-spacer'></td>".repeat(cellLen+1);
                    htmlData += "</tr>\n";
                    htmlData += "<tr class='prompt-row'>\n";
                    htmlData += "  <td>Prompt</td>\n";
                    htmlData += ("  <td>" + table.rows[rowLoop].cells[0].querySelector('.promptCell').innerHTML + "</td>").repeat(cellLen);
                    htmlData += "\n";
                } else {
                    htmlData += "<tr class='small-courier'>\n";
                    htmlData += "  <td>Statistics</td>\n";
                    for(cellLoop=0; cellLoop<cellLen; cellLoop++) {
                        var text = "";

                        if (table.rows[rowLoop].cells[cellLoop].querySelector('#firsttokenValue')) {
                            text += " ~ 1st tok: " + table.rows[rowLoop].cells[cellLoop].querySelector('#firsttokenValue').innerHTML + " s \n";
                            text += " ~ " + table.rows[rowLoop].cells[cellLoop].querySelector('#speedo-status').innerHTML.replace('<br>', ' ') + " \n";
                            text += " ~ tok/sec: " + table.rows[rowLoop].cells[cellLoop].querySelector('#tokspersecValue').innerHTML + " \n";

                            if ( table.rows[rowLoop]?.cells[cellLoop]?.querySelector('#upvote')?.className?.includes('upvoted') ) {
                                text += " ~ upvote: +1";
                            }
                            if ( table.rows[rowLoop]?.cells[cellLoop]?.querySelector('#downvote')?.className?.includes('downvoted') ) {
                                text += " ~ downvote: -1";
                            }
                        }
                        htmlData += "  <td>" + text + "</td>\n";
                    }
                    htmlData += "</tr>\n";

                    htmlData += "<tr>\n";
                    htmlData += "  <td>";
                    htmlData += table.rows[rowLoop].className === 'response-row' ? "Responses" : "Unknown";
                    htmlData += "  </td>\n";
                    for(cellLoop=0; cellLoop<cellLen; cellLoop++) {
                        if (table.rows[rowLoop].cells[cellLoop].querySelector('.raw-text')) {
                            htmlData += "  <td>" + table.rows[rowLoop].cells[cellLoop].querySelector('.raw-text').innerHTML + "</td>";
                        } else {
                            htmlData += "  <td>~ paused ~</td>";
                        }
                    }
                }

                htmlData += "</tr>\n";
            }

            htmlData += "</tbody></table></html>\n";

            var blob = new Blob([htmlData], { type: "text/html;charset=utf-8" });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Synthonnel_Parley_" + getFormattedDateTimeUnderscores() + ".html";
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function countClassInColumns() {
            const table = document.querySelector('#promptTable');
            const rows = table.rows;
            const columnCount = rows[0].children.length;
            const upVotes = Array(columnCount).fill(0);
            const dnVotes = Array(columnCount).fill(0);

            for (let rowLoop = 1; rowLoop < rows.length; rowLoop++) {
                for (let colLoop = 0; colLoop < columnCount; colLoop++) {
                    if ( rows[rowLoop]?.cells[colLoop]?.querySelector('#upvote')?.className?.includes('upvoted') ) {
                        upVotes[colLoop]++;
                    }
                    if ( rows[rowLoop]?.cells[colLoop]?.querySelector('#downvote')?.className?.includes('downvoted') ) {
                        dnVotes[colLoop]++;
                    }
                }
            }

            var headerRow = document.getElementById("headerRow");

            for (let colLoop = 0; colLoop < columnCount; colLoop++) {
                var item = headerRow.cells[colLoop];
                item.querySelector(".vote-count-display").innerHTML = "" + (upVotes[colLoop] - dnVotes[colLoop] + "");
                item.querySelector(".vote-count-display").title = `Total Votes: ${upVotes[colLoop] + dnVotes[colLoop]}\nUp Votes: ${upVotes[colLoop]}\nDown Votes: ${dnVotes[colLoop]}\nVote Tally: ${upVotes[colLoop] - dnVotes[colLoop]}`;
            }
        }


        function saveParleyXLSX() {
        }

        function escapeForCSV(inVal)
        {
            return '"' + inVal.replace('"', '""') + '"'
        }

        function escapeForTSV(inVal)
        {
            return inVal.replace('\t', '    ')
        }

        function getFormattedDateTimeUnderscores() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = now.toLocaleString('en-US', { month: 'short' });
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${day}${month}${year}_${hours}${minutes}${seconds}`;
        }

        function getFormattedDateTimePolite() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = now.toLocaleString('en-US', { month: 'short' });
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${day} ${month} ${year} ${hours}:${minutes}:${seconds}`;
        }

    </script>
</body>
</html>
