<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthonnel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #F0F0F0;
            color: #0F0F0F;
        }
        #addItemForm {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: fixed; 
            left: 20px; 
            bottom: 80px; 
            background: white; 
            padding: 20px; 
            border: 1px solid #ccc; 
            display: grid; 
            gap: 20px;
        }

        #trashcan {
            position: fixed; 
            left: 20px; 
            bottom: 16px; 
            font-size: 24px;
        }
        #trashcan.highlight {
            background-color: #f88;
            transition: background-color 0.3s;
        }
        
        #settingsBtn {
            cursor: pointer;
            position: fixed; 
            left: 30px; 
            bottom: 10px; 
            font-size: 24px; 
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 44px;
            width: 44px;
        }
        #addItemBtn {
            cursor: pointer;
            position: fixed; 
            left: 104px; 
            bottom: 10px; 
            font-size: 24px; 
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 44px;
            width: 44px;
        }

        #userPrompt {
            overflow-y: hidden;
            width: calc(100% - 300px);
            margin: 0 auto;
            min-height: 34px;
            height: auto;
            resize: none;
            position: fixed;
            left: 174px;
            bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        #submitPrompt {
            position: fixed; 
            right: 30px; 
            bottom: 10px; 
            font-size: 24px; 
            border: none;
            opacity: 0.3;
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 44px;
            width: 44px;
        }

        #addItemFormHider {
            display:none
        }

        #promptTable {
            width: 100%;
            border-spacing: 20px;
            border-collapse: separate;
            vertical-align: top;
        }
        #promptTable th, #promptTable td {
            padding: 8px;
        }
        .prompt-row {
            font-style: italic;
            column-span: all;
        }
        #promptTable thead th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }
        .table-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            overflow-y: auto;
            table-layout: fixed;
            word-break: break-word;
        }
        .headerElement {
            width: 2%;
            border-bottom: 1px solid #000;
        }
        #headerRow {
            text-align: center;
        }
        .response-row {
            vertical-align: top;
            background-color: white;
        }

        #message {
            position: absolute;
            top: calc(100% - 200px);
            width: 25%;
            left: 50%;
            background-color: white;
            color: darkred;
            padding: 10px;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

    </style>
</head>
<body>
    <div class="table-container" id="table-container">
        <table id="promptTable">
            <thead>
                <tr id="headerRow">
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <button id="settingsBtn" title="Settings">â˜°</button>
    <button id="addItemBtn" title="Add New Model">+</button>
    <div id="addItemFormHider">
        <div id="addItemForm">
            <input type="text" id="newItemProvider" placeholder="Provider">
            <input type="text" id="newItemModel" placeholder="Model">
            <textarea id="newItemParameters" placeholder="Parameters" rows="4" style="resize: vertical;"></textarea>
            <input type="text" id="newItemProviderUrl" placeholder="ProviderUrl">
            <input type="text" id="newItemApiKey" placeholder="ApiKey">
            <button id="confirmAddItem">Add</button>
        </div>
    </div>

    <textarea id="userPrompt" placeholder="Enter your message here..."></textarea>
    <button id="submitPrompt" title="Send Message">ðŸ ‰</button>

    <div id="message">Disappearing message</div>

    <script>
        function showMessage(message) {
            const messageElement = document.getElementById('message');
            messageElement.innerText = message;
            messageElement.style.opacity = '1';

            setTimeout(() => {
                messageElement.style.opacity = '0';
            }, 3000);
        }

        document.getElementById('userPrompt').addEventListener('input', function(event) {
            const textAreaElement = document.getElementById('userPrompt');
            document.getElementById('submitPrompt').style.opacity = textAreaElement.value.trim().length == 0 ? '0.3' : '1';
        });

        document.getElementById('submitPrompt').addEventListener('click', function() {
            document.getElementById('submitPrompt').style.opacity = '0.3';
            const textAreaElement = document.getElementById('userPrompt');
            const prompt = textAreaElement.value.trim();

            textAreaElement.value = '';
            textAreaElement.style.height = 'auto';
            textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;

            if (!prompt) {
                return;
            }

            const table = document.querySelector('#promptTable');
            const headerRow = table.rows[0];
            const headerCells = headerRow.cells;
            const tableContainer = document.getElementById("table-container")
            const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

            const promptRow = table.insertRow(-1);
            const promptCell = promptRow.insertCell(0);
            promptCell.className = 'prompt-row';
            promptCell.colSpan = headerCells.length;
            promptCell.innerHTML = "PROMPT: " + prompt;

            const newRow = table.insertRow(-1);
            newRow.className = 'response-row';
            
            if (isAtBottom) {
                tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight
            }

            Array.from(headerCells).forEach((item, index) => {
                const newCell = newRow.insertCell(index);
                const ws = new WebSocket(`ws://localhost:8000/ws/stream-llm-response`);

                ws.onopen = function(event) {
                    const itemData = {
                        prompt: prompt,
                        provider: item.getAttribute('data-provider'),
                        model: item.getAttribute('data-model'),
                        parameters: item.getAttribute('data-parameters'),
                        providerUrl: item.getAttribute('data-providerUrl'),
                        apiKey: item.getAttribute('data-apiKey')
                    };
                    ws.send(JSON.stringify(itemData));
                };

                ws.onmessage = function(event) {
                    const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

                    newCell.innerHTML += event.data + ' ';

                    if (isAtBottom) {
                        tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight
                    }
                };

                ws.onerror = function(event) {
                    console.error("WebSocket error observed:", event);
                    showMessage("WebSocket error observed:", event);
                };

                ws.onclose = function(event) {
                    console.log("WebSocket connection closed for", item.getAttribute('data-provider'));
                };
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            fetch('http://localhost:8000/get-items')
                .then(response => response.json())
                .then(data => {
                    const headerRow = document.getElementById('headerRow');

                    data.forEach(item => {
                        const th = addColumn(item);
                        headerRow.appendChild(th);
                    });
                })
                .catch(error => console.error('Error loading table header data:', error));
        });

        function addColumn(item) {
            const th = document.createElement('th');
            th.className = 'headerElement';
            th.textContent = item.provider;

            th.setAttribute('data-provider', item.provider);
            th.setAttribute('data-model', item.model);
            th.setAttribute('data-parameters', item.parameters);
            th.setAttribute('data-providerUrl', item.providerUrl);
            th.setAttribute('data-apiKey', item.apiKey);

            return th;
        }

        document.getElementById('addItemBtn').onclick = function() {
            if (document.getElementById('addItemFormHider').style.display == 'block') {
                document.getElementById('addItemFormHider').style.display = 'none'
            } else {
                document.getElementById('addItemFormHider').style.display = 'block';
            }
        };

        document.getElementById('confirmAddItem').onclick = async function() {
            const item = {
                provider: document.getElementById('newItemProvider').value.trim(),
                model: document.getElementById('newItemModel').value.trim(),
                parameters: document.getElementById('newItemParameters').value.trim(),
                providerUrl: document.getElementById('newItemProviderUrl').value.trim(),
                apiKey: document.getElementById('newItemApiKey').value.trim()
            };

            if (item.provider && item.model && item.providerUrl && item.apiKey) {
                // check if the item already exists in the table header before adding it again 
                const headerCells = document.querySelectorAll('#promptTable thead th');
                const itemExists = Array.from(headerCells).some(th => 
                    th.getAttribute('data-provider') === item.provider &&
                    th.getAttribute('data-model') === item.model &&
                    th.getAttribute('data-parameters') === item.parameters &&
                    th.getAttribute('data-providerUrl') === item.providerUrl &&
                    th.getAttribute('data-apiKey') === item.apiKey
                );

                if (itemExists) {
                    showMessage("Duplicate erntry.");
                    return;
                }

                const headerRow = document.getElementById('headerRow');
                const th = addColumn(item);
                headerRow.appendChild(th);

                saveItems();
                document.getElementById('addItemFormHider').style.display = 'none'
            } else {
                showMessage("All fields are required.");
            }
        };

        async function saveItems() {
            const headerCells = document.querySelectorAll('#promptTable thead th');

            const items = Array.from(headerCells).map(th => ({
                provider: th.getAttribute('data-provider'),
                model: th.getAttribute('data-model'),
                parameters: th.getAttribute('data-parameters'),
                providerUrl: th.getAttribute('data-providerUrl'),
                apiKey: th.getAttribute('data-apiKey'),
            }));

            fetch('http://localhost:8000/save-items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Items saved successfully.");
                } else {
                    console.error("Failed to save items.");
                    showMessage("Failed to save items.");
                }
            })
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            const textarea = document.getElementById('userPrompt');
            
            function autoGrowTextArea(textAreaElement) {
                textAreaElement.style.height = 'auto';
                textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;
            }
            
            textarea.addEventListener('input', function() {
                autoGrowTextArea(this);
            });

            autoGrowTextArea(textarea);
        });

    </script>
</body>
</html>
