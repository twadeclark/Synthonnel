<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthonnel</title>
    <style>
        :root {
            --backgroundColor: #F0F0F0;
            --textColor: #0F0F0F;
            --emphasisBackgroundColor: #FFFFFF;
            --borderColor: #C0C0C0;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--backgroundColor);
            color: var(--textColor);
            line-height: 160%;
        }
        *{
            transition: background-color 0.5s ease-in-out;
        }

        .button {
            cursor: pointer;
            font-size: 24px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: 44px;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }

        .small-text-wide-button {
            cursor: pointer;
            font-size: 80%;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            height: 44px;
            width: 100%;
            background-color: var(--backgroundColor);
            color: var(--textColor);
        }

        #addItemBtn {
            position: fixed; 
            left: 104px; 
            bottom: 10px; 
            background-color: var(--emphasisBackgroundColor);
        }
        #addItemFormHider {
            display:none
        }
        #addItemForm {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: fixed; 
            left: 20px;
            bottom: 80px; 
            background: var(--emphasisBackgroundColor); 
            padding: 20px; 
            border: 1px solid var(--borderColor); 
            display: grid; 
            gap: 20px;
        }

        #userPrompt {
            left: 174px;
            right: 174px;
            overflow-y: hidden;
            margin: 0 auto;
            min-height: 1px;
            height: auto;
            resize: none;
            position: fixed;
            bottom: 10px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            font-size: 120%;
            padding-top: 12px;
            padding-bottom: 0px;
            padding-right: 18px;
            padding-left: 18px;
            background-color: var(--emphasisBackgroundColor);
            color: var(--textColor);
        }

        #submitPrompt {
            position: fixed; 
            right: 104px; 
            bottom: 10px; 
            opacity: 0.3;
            background-color: var(--emphasisBackgroundColor);
        }

        #settingsBtn {
            position: fixed; 
            right: 30px; 
            bottom: 10px; 
            background-color: var(--emphasisBackgroundColor);
        }
        #settingsFormHider {
            display:none
        }
        #settingsForm {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: fixed; 
            right: 20px;
            bottom: 80px; 
            background: var(--emphasisBackgroundColor); 
            padding: 20px; 
            border: 1px solid var(--borderColor); 
            gap: 20px;
        }

        #message {
            position: absolute;
            left: 240px;
            bottom: 80px; 
            background-color: white;
            color: darkred;
            padding: 10px;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
        }

        .class1 {
            display: block;
        }
        .class2 {
            display: none;
        }
        .class3 {
            display: none;
            font-weight: normal;
            font-size: small;
            font-family: 'Courier New', Courier, monospace;
            line-height: 100%;
            text-align: left;
            white-space: pre-line;
            margin-top: 6px;
        }
        .class4 {
            display: none;
            font-weight: normal;
            font-size: small;
            font-family: 'Courier New', Courier, monospace;
            line-height: 100%;
            text-align: left;
            margin-top: 6px;
        }
        #promptTable {
            width: 100%;
            border-spacing: 10px;
            border-collapse: separate;
            vertical-align: top;
        }
        td {
            padding: 12px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
        }
        .prompt-row {
            font-style: italic;
            background-image: linear-gradient(var(--backgroundColor), var(--emphasisBackgroundColor), var(--backgroundColor));
            text-align: center;
            padding-left: 174px;
            padding-right: 174px;
        }
        #promptTable thead th {
            position: sticky;
            top: 0;
            background-color: var(--emphasisBackgroundColor);
            z-index: 1;
        }
        .table-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 60px;
            overflow-y: auto;
            table-layout: fixed;
            word-break: break-word;
        }
        .headerElement {
            padding: 8px;
            width: 2%;
            border-bottom: 1px solid var(--borderColor);
        }
        #headerRow {
            text-align: center;
            vertical-align: top;
        }
        .response-row {
            vertical-align: top;
            background-color: var(--emphasisBackgroundColor);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            top: -8px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #F0F0F0;
            -webkit-transition: .4s;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: #888888;
            -webkit-transition: .4s;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #606060;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px gray;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        .dropdown-content {
            color: var(--textColor);
            background-color: var(--emphasisBackgroundColor);
            display: block;
            position: absolute;
            width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            padding: 10px;
            border: 1px solid var(--borderColor);
            border-radius: 8px;
            top: 40px;
        }
        .dropdown-content a {
            color: var(--textColor);
            background-color: var(--emphasisBackgroundColor);
            text-decoration: none;
            font-weight: normal;
            padding-left: 6px;
            padding-right: 6px;
            display: inline-block;
            border: 1px solid var(--borderColor);
        }
        .dropdown-content a:hover {
            background-color: var(--backgroundColor);
        }
        .dropdown-content-narrow {
            display: inline-block;
            width: 40px;
            text-align: center;
            margin-bottom: 10px;
        }
        .dropdown-content-plusminus {
            display: inline-block;
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 150%;
            padding-top: 12px;
        }
        .dropdown-content-delete {
            display: initial;
        }
        .dropdown-content-pause {
            display: none;
        }

        details {
            padding: 0;
        }
        summary {
            font-weight: bold;
            margin: 0;
            padding: 0;
            height: 24px;
            width: 24px;
            position: absolute;
        }
        details[open] {
            padding: 0;
        }
        details[open] summary {
            padding: 0;
        }

        a {
            border: 1px solid var(--borderColor);
            border-radius: 8px;
        }

        .red-shadow {
            text-shadow: 0 0 1px #FF0000;
            font-size: 80%;
        }

        .center {
            text-align: center;
            vertical-align: middle;
        }

    </style>
</head>
<body>
    <div class="table-container" id="table-container">
        <table id="promptTable">
            <thead>
                <tr id="headerRow">
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <button id="addItemBtn" class="button" title="Add New Model">+</button>
    <div id="addItemFormHider">
        <div id="addItemForm">
            <input type="text" id="newItemModel" placeholder="Model">
            <input type="text" id="newItemProvider" placeholder="Provider">
            <input type="text" id="newItemProviderUrl" placeholder="ProviderUrl">
            <textarea id="newItemParameters" placeholder="Parameters" rows="4" style="resize: vertical;"></textarea>
            <input type="text" id="newItemApiKey" placeholder="ApiKey">
            <button id="confirmAddItem" class="button small-text-wide-button">Add Model</button>
        </div>
    </div>

    <textarea id="userPrompt" rows="1" placeholder="Enter your message here..."></textarea>

    <button id="submitPrompt" class="button" title="Send Message">🠉</button>

    <button id="settingsBtn" class="button" title="Settings">☰</button>
    <div id="settingsFormHider">
        <div id="settingsForm">
            <div style="text-align: center;">
                <label style="font-size: 24px;">🌞</label>
                <label class="switch">
                    <input type="checkbox" id="darkMode">
                    <span class="slider round"></span>
                </label>
                <label style="font-size: 24px;" for="darkMode">🌛</label>
            </div>
            <hr>
            <input type="checkbox" id="check1" checked> <label for="check1">Model</label> <br>
            <input type="checkbox" id="check2"> <label for="check2">Provider</label> <br>
            <input type="checkbox" id="check4"> <label for="check4">Provider Url</label> <br>
            <input type="checkbox" id="check3"> <label for="check3">Parameters</label> <br>
            <hr>
            <button id="startNewChat" class="button small-text-wide-button">New Chat</button>
        </div>
    </div>

    <div id="message">Disappearing message</div>

    <script>
        const menuContainers = document.querySelectorAll(".menu-container");

        menuContainers.forEach(container => {
            const menuIcon = container.querySelector(".menu-icon");
            const menu = container.querySelector(".menu");

            menuIcon.addEventListener("click", function() {
                menu.classList.toggle("show");
            });
        });

        function deleteColumn(indexToRemove) {
            if (!confirm("Confirm remove model?")) {
                return;
            }

            var row = document.getElementById("headerRow");
            row.deleteCell(indexToRemove);

            saveAndRefresh();
        }

        function pauseColumn(columnIndex) {
            var row = document.getElementById("headerRow");
            var pausedVal = row.cells[columnIndex].getAttribute('data-paused');
            var scale = pausedVal ? 1 : 0.75;
            row.cells[columnIndex].setAttribute('data-paused', pausedVal ? '' : 'true');

            const table = document.querySelector('table');
            let rows = table.rows;

            for (let i = 0; i < rows.length; i++) {
                let cells = rows[i].cells;
                if (cells.length > columnIndex) {
                    cells[columnIndex].style.transform = `scale(${scale})`;
                }
            }

            const detailsElements = document.querySelectorAll('details[open]');
                detailsElements.forEach(function(detailsElement) {
                detailsElement.removeAttribute('open');
                });
        }
        
        function moveColumnLeft(cellIndex) {
            var targetRow = document.getElementById("headerRow");
            const cells = targetRow.cells;
            const cellToMove = cells[cellIndex];
            const lastCellIndex = cells.length - 1;

            if (cellIndex === 0) {
                targetRow.appendChild(cellToMove);
            } else {
                const previousCell = cells[cellIndex - 1];
                targetRow.insertBefore(cellToMove, previousCell);
            }

            saveAndRefresh();
        }

        function moveColumnRight(cellIndex) {
            var targetRow = document.getElementById("headerRow");
            const cells = targetRow.cells;
            const cellToMove = cells[cellIndex];
            const lastCellIndex = cells.length - 1;

            if (cellIndex === lastCellIndex) {
                targetRow.insertBefore(cellToMove, targetRow.firstChild);
            } else {
                const nextCell = cells[cellIndex + 1];
                    targetRow.insertBefore(nextCell, cellToMove);
            }

            saveAndRefresh();
        }

        function saveAndRefresh() {
            saveItems();

            var row = document.getElementById("headerRow");
            rowLen = row.cells.length;

            while (row.cells.length) row.deleteCell(row.cells.length - 1);

            setTimeout(() => { loadModels(); }, 1);
        }

        function showMessage(message) {
            const messageElement = document.getElementById('message');
            messageElement.innerText = message;
            messageElement.style.opacity = '1';

            setTimeout(() => {
                messageElement.style.opacity = '0';
            }, 3000);
        }

        document.getElementById('userPrompt').addEventListener('input', function(event) {
            const textAreaElement = document.getElementById('userPrompt');
            document.getElementById('submitPrompt').style.opacity = textAreaElement.value.trim().length == 0 ? '0.3' : '1';
        });

        document.getElementById('submitPrompt').addEventListener('click', function() {
            document.getElementById('submitPrompt').style.opacity = '0.3';
            const textAreaElement = document.getElementById('userPrompt');
            const prompt = textAreaElement.value.trim();

            textAreaElement.value = '';
            textAreaElement.style.height = 'auto';
            textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;

            if (!prompt) {
                return;
            }

            const elementsPause = document.querySelectorAll(`.dropdown-content-pause`);
            elementsPause.forEach(element => {
                element.style.display = "block";
            });

            const elementsDelete = document.querySelectorAll(`.dropdown-content-delete`);
            elementsDelete.forEach(element => {
                element.style.display = "none";
            });

            const table = document.querySelector('#promptTable');
            const headerRow = table.rows[0];
            const headerCells = headerRow.cells;
            const tableContainer = document.getElementById("table-container")
            const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

            const promptRow = table.insertRow(-1);
            const promptCell = promptRow.insertCell(0);
            promptCell.className = 'prompt-row';
            promptCell.colSpan = '100';
            promptCell.innerHTML = "PROMPT: " + prompt;

            const newRow = table.insertRow(-1);
            newRow.className = 'response-row';
            
            if (isAtBottom) {
                tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight
            }

            Array.from(headerCells).forEach((item, index) => {
                const newCell = newRow.insertCell(index);

                if (isAtBottom) {
                    tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight
                }

                var pausedVal = item.getAttribute('data-paused');

                if (pausedVal) {
                    newCell.innerHTML = '~ paused ~';
                    newCell.style.transform = "scale(0.75)";
                    newCell.className = "center";
                } else {
                    const ws = new WebSocket(`ws://localhost:8000/ws/stream-llm-response`);

                    ws.onopen = function(event) {
                        const itemData = {
                            prompt: prompt,
                            provider: item.getAttribute('data-provider'),
                            model: item.getAttribute('data-model'),
                            parameters: item.getAttribute('data-parameters'),
                            providerUrl: item.getAttribute('data-providerUrl'),
                            apiKey: item.getAttribute('data-apiKey')
                        };
                        ws.send(JSON.stringify(itemData));
                    };

                    ws.onmessage = function(event) {
                        const isAtBottom = tableContainer.scrollHeight - tableContainer.clientHeight <= tableContainer.scrollTop + 50;

                        newCell.innerHTML += event.data + ' ';

                        if (isAtBottom) {
                            tableContainer.scrollTop = tableContainer.scrollHeight - tableContainer.clientHeight
                        }
                    };

                    ws.onerror = function(event) {
                        console.error("WebSocket error observed:", event);
                        showMessage("WebSocket error observed:", event);
                    };

                    ws.onclose = function(event) {
                        console.log("WebSocket connection closed for", item.getAttribute('data-provider'));
                    };
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadModels();

            function toggleVisibility(checkboxId, className) {
                const checkbox = document.getElementById(checkboxId);
                checkbox.addEventListener('change', function() {
                    const elements = document.querySelectorAll(`.${className}`);
                    elements.forEach(element => {
                        element.style.display = checkbox.checked ? "block" : "none";
                    });
                });
            }

            toggleVisibility('check1', 'class1');
            toggleVisibility('check2', 'class2');
            toggleVisibility('check3', 'class3');
            toggleVisibility('check4', 'class4');
        });

        function loadModels() {
            fetch('http://localhost:8000/get-items')
                .then(response => response.json())
                .then(data => {
                    const headerRow = document.getElementById('headerRow');

                    data.forEach((item, index) => {
                        const th = addColumn(item, index);
                        headerRow.appendChild(th);
                    });
                })
                .catch(error => console.error('Error loading table header data:', error));
        }

        function addColumn(item, index) {
            const th = document.createElement('th');
            th.className = 'headerElement';
            th.textContent = item.provider;
            th.innerHTML = `
                <details name="menu">
                    <summary></summary>
                    <div class="dropdown-content-delete">
                        <div class="dropdown-content">
                            <a href="#" class="dropdown-content-narrow" onclick="moveColumnLeft(${index})">⇦</a>
                            <a href="#" class="dropdown-content-narrow" onclick="moveColumnRight(${index})">⇨</a>
                            <a href="#" class="red-shadow" onclick="deleteColumn(${index})">Remove</a>
                        </div>
                    </div>
                    <div class="dropdown-content-pause">
                        <div class="dropdown-content">
                            <a class="dropdown-content-plusminus" onclick="pauseColumn(${index})" href="#">⏯️</a>
                        </div>
                    </div>
                </details>

                <div class="class1">${item.model}</div>
                <div class="class2">${item.provider}</div>
                <div class="class4">${item.providerUrl}</div>
                <div class="class3">${item.parameters}</div>
            `;

            th.setAttribute('data-provider', item.provider);
            th.setAttribute('data-model', item.model);
            th.setAttribute('data-parameters', item.parameters);
            th.setAttribute('data-providerUrl', item.providerUrl);
            th.setAttribute('data-apiKey', item.apiKey);

            return th;
        }

        document.getElementById('addItemBtn').onclick = function() {
            if (document.getElementById('addItemFormHider').style.display == 'block') {
                document.getElementById('addItemFormHider').style.display = 'none'
            } else {
                document.getElementById('addItemFormHider').style.display = 'block';
                document.getElementById('settingsFormHider').style.display = 'none'
            }
        };

        document.getElementById('settingsBtn').onclick = function() {
            if (document.getElementById('settingsFormHider').style.display == 'block') {
                document.getElementById('settingsFormHider').style.display = 'none'
            } else {
                document.getElementById('settingsFormHider').style.display = 'block';
                document.getElementById('addItemFormHider').style.display = 'none'
            }
        };

        document.getElementById('darkMode').onchange = function() {
            const body = document.body;
            if (document.getElementById('darkMode').checked) {
                document.documentElement.style.setProperty('--backgroundColor', '#2F2F2F');
                document.documentElement.style.setProperty('--textColor', '#F0F0F0');
                document.documentElement.style.setProperty('--emphasisBackgroundColor', '#000000');
                document.documentElement.style.setProperty('--borderColor', '#606060');
            } else {
                document.documentElement.style.setProperty('--backgroundColor', '#F0F0F0');
                document.documentElement.style.setProperty('--textColor', '#0F0F0F');
                document.documentElement.style.setProperty('--emphasisBackgroundColor', '#FFFFFF');
                document.documentElement.style.setProperty('--borderColor', '#C0C0C0');
            }
        };

        document.getElementById('confirmAddItem').onclick = async function() {
            const item = {
                provider: document.getElementById('newItemProvider').value.trim(),
                model: document.getElementById('newItemModel').value.trim(),
                parameters: document.getElementById('newItemParameters').value.trim(),
                providerUrl: document.getElementById('newItemProviderUrl').value.trim(),
                apiKey: document.getElementById('newItemApiKey').value.trim()
            };

            if (item.provider && item.model && item.providerUrl && item.apiKey) {
                const headerCells = document.querySelectorAll('#promptTable thead th');
                const itemExists = Array.from(headerCells).some(th => 
                    th.getAttribute('data-provider') === item.provider &&
                    th.getAttribute('data-model') === item.model &&
                    th.getAttribute('data-parameters') === item.parameters &&
                    th.getAttribute('data-providerUrl') === item.providerUrl &&
                    th.getAttribute('data-apiKey') === item.apiKey
                );

                if (itemExists) {
                    showMessage("Duplicate erntry.");
                    return;
                }

                const headerRow = document.getElementById('headerRow');
                const th = addColumn(item, headerRow.cells.length);
                headerRow.appendChild(th);

                saveItems();
                document.getElementById('addItemFormHider').style.display = 'none'
            } else {
                showMessage("All fields are required.");
            }
        };

        async function saveItems() {
            const headerCells = document.querySelectorAll('#promptTable thead th');

            const items = Array.from(headerCells).map(th => ({
                provider: th.getAttribute('data-provider'),
                model: th.getAttribute('data-model'),
                parameters: th.getAttribute('data-parameters'),
                providerUrl: th.getAttribute('data-providerUrl'),
                apiKey: th.getAttribute('data-apiKey'),
            }));

            fetch('http://localhost:8000/save-items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Items saved successfully.");
                } else {
                    console.error("Failed to save items.");
                    showMessage("Failed to save items.");
                }
            })
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            const textarea = document.getElementById('userPrompt');
            
            function autoGrowTextArea(textAreaElement) {
                textAreaElement.style.height = 'auto';
                textAreaElement.style.height = `${textAreaElement.scrollHeight}px`;
            }
            
            textarea.addEventListener('input', function() {
                autoGrowTextArea(this);
            });

            autoGrowTextArea(textarea);
        });

    </script>
</body>
</html>
